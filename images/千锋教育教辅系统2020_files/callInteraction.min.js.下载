"use strict";!function(e,t){function i(t){this.socket=t.socket,this.container=t.container,this.sessionId=t.sessionId,this.channelId=t.channelId,this.player=t.player,this.nick=t.nick,this.pic=t.pic,this.userId=t.userId,this.uid=t.uid,this.accountId=t.accountId,this.teacherId=t.teacherId,this.livestatus=t.livestatus,this.rtcEnabled=t.rtcEnabled||"N",this.isCcb=t.isCcb,this.chatApiHost=t.chatApiHost,this.apiHost=t.apiHost,this.supportCall=!1,this.microphoneStatus="close",this.userType="student",this.isHttps="https:"===location.protocol,this.listClock=null,this.sendJoinSuccessCount=0,this.isSendJoinSuccess=!1,this.initVolume=0,this.body=e("body"),this.videoCallListDom=null,this.videoCallList={},this.videoChatToken=null,this.init()}var s=null,n=!1,a={clock:null,createTip:function(t){void 0===t&&(t="default");var i="js-polyv-link-mic-tip polyv-link-mic-tip polyv-link-mic-tip-"+t;e("body").append('<div class="'+i+'">请使用Chrome(58及以上版本)浏览器打开观看页参与连麦(仅支持 HTTPS)</div>')},showTip:function(t,i){var s,n,a=this;clearTimeout(a.clock),e(".js-polyv-link-mic-tip").remove(),0===arguments.length?(s="default",n=2):1===arguments.length?"number"==typeof arguments[0]?(s="default",n=arguments[0]):(s=arguments[0],n=2):arguments.length>=2&&(s=t,n=i),a.createTip(s),a.clock=setTimeout(function(){clearTimeout(a.clock),a.clock=null,e(".polyv-link-mic-tip").remove()},1e3*n)}};i.prototype={init:function(){AgoraRTC.Logger.setLogLevel(AgoraRTC.Logger.ERROR);var e=navigator.userAgent.toLocaleLowerCase();-1===e.indexOf("safari")&&-1===e.indexOf("firefox")||-1!==e.indexOf("windowswechat")||(this.supportCall=AgoraRTC.checkSystemRequirements()),this.createWrap(),console.log(this.supportCall?"当前浏览器支持连麦":"当前浏览器不支持连麦"),this.supportCall?this.getInteractStatus().setClock():-1===e.indexOf("windowswechat")||n?this.callMain.append(this.tip("browsertip")):(n=!0,a.showTip("warn")),this.initSocketEvent()},changeSessionId:function(e){this.sessionId=e},setUserInfo:function(e){e&&(e.nick&&(this.nick=e.nick),e.pic&&(this.pic=e.pic),e.userId&&(this.userId=e.userId),e.uid&&(this.uid=e.uid))},createWrap:function(){var t=this;this.container.append('<div class="connect-microphone-wrap"><div class="connect-mp-hd"><h4 class="connect-mp-title">'+i18nText.lm+'</h4><span class="connect-mp-toggle-arrow-up" id="js-connect-mp-toggle-arrow" data-status="down"></span></div><div class="connect-mp-bd"><div class="connect-mp-bd-contain"><div class="pos-rel connect-mp-talk-main" id="connect-mp-talk-main"></div></div></div><div class="connect-mp-mask" id="connect-mp-mask"><div class="connect-mp-mask-contain" id="connect-mp-mask-contain"></div></div>'+"</div>".trim()),this.callMain=e("#connect-mp-talk-main"),this.alertBoxWrap=e("#connect-mp-mask"),this.alertBox=e("#connect-mp-mask-contain"),e("#js-connect-mp-toggle-arrow").on("click",function(){e(this).toggleClass("connect-mp-toggle-arrow-up connect-mp-toggle-arrow-down"),t.container.toggleClass("hide-call")})},tip:function(e){var t="";return"browsertip"===e&&(t='<div class="browser-tip" id="browser-tip"><p>'+i18nText.lmBrowserTip+"<br/>"+i18nText.lmBrowserTip2+"</p>"+"</div>".trim()),"securitytip"===e&&(t='<div class="security-tip" id="security-tip"><p>'+i18nText.lmLinkTip+'<br/><a href="https://'+location.hostname+location.pathname+location.search+'">'+i18nText.lmLinkTipCurpage+"</a></p>"+"</div>".trim()),"unopentip"===e&&(t='<div class="unopen-tip" id="unopen-tip"><p>'+i18nText.lmClosedTip+"</p>"+"</div>".trim()),t},initDomEvent:function(){var e=this,t=e.callMain;return e.btnRaise.on("click",function(){t.hasClass("no-raise")?(e.isRaise=!0,e.joinRequest(),t.removeClass("no-raise").addClass("in-raise")):t.hasClass("in-raise")?(t.removeClass("in-raise").addClass("no-raise"),e.cancelJoinRequest()):t.hasClass("in-call")&&e.studentEndCall()}),this},publishErrorCallback:function(){this.leaveCall();var e=i18nText.lmCallFailed;this.errTip(e)},initSocketEvent:function(){if(!this.socket)return this;var t=this;this.socket.on("message",function(i){if((i=JSON.parse(i))&&i.EVENT)switch(i.EVENT){case"LOGOUT":t.uid!==i.uid&&e('#call-list>li[data-uid="'+i.uid+'"]').remove();break;case"OPEN_MICROPHONE":if(!t.supportCall)break;"open"===i.status?(t.sessionId=i.sessionId||t.sessionId,t.getInteractStatus().setClock()):t.handleStatus(i)}}),this.socket.on("joinRequest",function(e){e=JSON.parse(e);var i=e.user;t.videoCallList[i.userId]=i.nick,i.userId!==t.userId&&t.renderCallList([i])}),this.socket.on("joinResponse",function(e){e=JSON.parse(e),t.btnRaise.attr("disabled",!0),t.linkMicrophone.join().then(function(){}).catch(function(e){console.log(e),t.leaveCall();var i=i18nText.lmCallFailed;"NotReadableError"===e.msg&&(i=i18nText.lmDeviceOccupied),t.errTip(i)})}),this.socket.on("joinSuccess",function(i){i=JSON.parse(i),e("#call-"+i.user.userId).find(".connect-mp-talk-status").addClass(t.linkTypeClass).text(i18nText.lmCalling)}),this.socket.on("joinLeave",function(t){t=JSON.parse(t),e("#call-"+t.user.userId).remove()})},getCallUserList:function(){return new Promise(function(t,i){e.ajax({url:this.chatApiHost+"/front/listLinkMicUsers",type:"GET",dataType:"jsonp",data:{roomId:this.channelId}}).done(function(e){t(e)})})},getInteractStatus:function(){var t=this;return e.ajax({url:this.chatApiHost+"/interact-status/"+this.channelId+"&sessionId="+this.sessionId,type:"GET",dataType:"jsonp"}).done(function(e){t.handleStatus(e)}),this},getRtcEnabled:function(){var t=this;return new Promise(function(i){e.ajax({url:this.apiHost+"/live/rtc/get-rtc-enabled",type:"GET",dataType:"json",data:{channelId:t.channelId}}).done(function(e){i(e)})})},setClock:function(){var e=this;this.clearClock(),this.listClock=setInterval(function(){e.getInteractStatus()},2e4)},clearClock:function(){clearInterval(this.listClock),this.listClock=null},handleStatus:function(i){if(i){var s=i.microphoneStatus||i.status;if(s===this.microphoneStatus)return void("open"===this.microphoneStatus&&this.renderCallList(this.sortUsers(i.joinList.concat(i.waitList)),!0));"open"===s?(this.microphoneStatus="open",this.callType=i.type,"video"==i.type?(this.enableVideo=!0,this.linkTypeClass="ontalk-video"):(this.enableVideo=!1,this.linkTypeClass="ontalk-audio"),this.isHttps?(this.createCallPanel().renderCallList(this.sortUsers(i.joinList.concat(i.waitList)),!0),this.linkMicrophone=new t({target:this,channel:this.channelId,uid:this.userId,isCcb:this.isCcb,apiHost:this.apiHost,accountId:this.accountId,container:"agroa-video-container",enableVideo:this.enableVideo,success:this.joinCallSuccess,joinChannelCallBack:this.joinChannelCallBack.bind(this),publishErrorCallback:this.publishErrorCallback.bind(this),errorFun:this.linkError,streamSubscribed:this.streamSubscribed,peerLeave:this.peerLeave})):(e("#browser-tip").length&&e("#browser-tip").hide(),this.callMain.append(this.tip("securitytip"))),this.container.addClass("main-right-container-live")):i.userId?i.userId==this.userId?(this.closeCall=!0,this.teacherEndCall()):e("#call-"+i.userId).remove():(this.microphoneStatus="close",this.isJoined&&this.leaveCall(),this.container.removeClass("main-right-container-live hide-call"),this.callMain.html(""),this.alertBox.empty(),this.alertBoxWrap.hide(),this.initCallStatus(),this.clearClock(),this.callList=null)}},linkError:function(e){console.log("### ",e),e.reason},createVideoCallList:function(t){var i=t.getId();e("#mboxTab");this.videoCallListDom.prepend('<div class="video-call-box"><div id="remote-stream-'+i+'"></div><span class="video-call-user-name">'+this.videoCallList[i]+"</span></div>"),t.play("remote-stream-"+i)},createVideoCallDom:function(){var t=e("#mboxTab"),i=t.children("li").length;e("#mboxPanelsWrap").prepend('<div class="video-call-list" id="videoCallList"></div>'),t.prepend('<li data-target="#videoCallList">连线</li>').removeClass("mbox-tab-"+i).addClass("mbox-tab-"+(i+1)).children("li").eq(0).trigger("click"),this.videoCallListDom=e("#videoCallList")},joinChannelCallBack:function(){"Y"===this.rtcEnabled&&"video"===this.callType&&this.createVideoCallDom()},joinCallSuccess:function(t){if(console.log("###:","Publish local stream successfully/",this.isRaise),"open"!==this.microphoneStatus||this.closeCall)this.leaveCall();else{this.isJoined=!0,this.joinSuccess();var i=t.stream.getId();if("Y"===this.rtcEnabled&&"video"===this.callType)this.createVideoCallList(t.stream);else{e("#remote-stream-"+i).remove(),this.body.append('<div id="remote-stream-'+i+'"></div>');var s=setTimeout(function(){t.stream.play("remote-stream-"+i),clearTimeout(s),s=null},300)}}},streamSubscribed:function(t){var i=this,s=t.stream,n=s.getId(),a="remote-stream-"+n,l=e("#"+a);console.log("订阅的是否是讲师",n==this.teacherId),console.log("streamSubscribed:",this.rtcEnabled,n,this.teacherId),"Y"===this.rtcEnabled?n==this.teacherId?(l.remove(),e(".player-layer").append('<div id="'+a+'" class="plv-agoraRTC-stream-wrap"></div>'),this.player&&this.player.j2s_pauseVideo&&this.player.j2s_pauseVideo(),e(".player-main").height(1)):"video"===this.callType?(l.length&&l.parent(".video-call-box").remove(),this.videoCallListDom.append('<div class="video-call-box"><div id="'+a+'"></div></div>').addClass("multi-video-call"),e("#"+a).parent(".video-call-box").append('<span class="video-call-user-name">'+(i.videoCallList[n]||i.videoCallList[n.toString()])+"</span>")):(l.remove(),this.body.append('<div id="'+a+'"></div>')):(l.remove(),this.body.append('<div id="'+a+'"></div>')),s.play(a)},peerLeave:function(t){console.log("peerLeave"),e("#remote-stream-"+t.uid).parent(".video-call-box").remove(),delete this.videoCallList[t.uid],e("#videoCallList>.video-call-box").length<=1&&this.videoCallListDom.removeClass("multi-video-call")},createCallPanel:function(){return this.callList?this:(this.callMain.html('<ul class="connect-mp-talk-list" id="call-list"></ul><div class="connect-mp-talk-ft"><button type="button" class="btn-call raise">'+i18nText.lmRaiseHand+'</button><button type="button" class="btn-call cancel">'+i18nText.lmCancelCall+'</button><button type="button" class="btn-call end">'+i18nText.lmEndCall+"</button>"+"</div>".trim()).addClass("no-raise"),this.callList=e("#call-list"),this.btnRaise=e(".btn-call"),this.initDomEvent(),this)},renderCallList:function(e,t){var i=this;t&&i.callList.html(""),e.forEach(function(e){var t=e.userId,s=e.userType,n="",a="";if(i.callList.children("#"+t).remove(),t==i.userId){if(!i.isJoined&&!i.isRaise)return;e.nick+="（"+i18nText.me+"）",a=" self"}e.actor?n=e.actor:"teacher"===s?n=i18nText.lmTeacher:"assistant"===s&&(n=i18nText.lmAssistant);var l='<li class="clearfix'+a+'" id="call-'+t+'" data-uid="'+e.uid+'"><div class="fl pos-rel connect-mp-talk-left"><span><img src="'+e.pic+'" class="connect-mp-talk-pic" /></span><span class="connect-mp-talk-nick" title="'+e.nick+'">'+e.nick;n&&(l+='</span><span class="talk-actor">'+n),l+='</span></div><div class="fr connect-mp-talk-right"><span class="connect-mp-talk-status',"wait"==e.status?l+='">'+i18nText.lmWaiting+"...":l+=" "+i.linkTypeClass+'">'+i18nText.lmCalling,l+="</span></div></li>","teacher"===s?i.callList.prepend(l):i.callList.append(l),i.videoCallList[t]=e.nick})},sortUsers:function(e){var t=this;return e.forEach(function(e){var i=e.userType;return"teacher"===i?e.index=1:"assistant"===i?e.index=2:e.userId===t.userId?e.index=3:e.index=4,e}),e.sort(function(e,t){return e.index>t.index}),e},getPlayerVolume:function(){return"application/x-shockwave-flash"===this.player.type?this.player.j2s_getVolume():this.player.vol},setPlayerVolume:function(e){if(this.player)try{e||(this.initVolume=this.getPlayerVolume()),this.player.j2s_setVolume(e?this.initVolume:0),this.player.showVolumePanel(e)}catch(e){console.error(e)}},joinRequest:function(){var e=this,t=!1,i={nick:e.nick,pic:e.pic,userId:e.userId,sessionId:e.sessionId,uid:e.uid,status:"wait",userType:e.userType};this.videoChatToken=null,e.socket.emit("joinRequest",JSON.stringify({user:i,roomId:e.channelId}),function(){t=!0,e.renderCallList([i])});var s=setTimeout(function(){t||e.initCallStatus(),clearTimeout(s),s=null},2e4)},cancelJoinRequest:function(){var e=this,t={nick:e.nick,pic:e.pic,userId:e.userId,sessionId:e.sessionId,uid:e.uid,status:e.isJoined?"join":"wait",userType:e.userType},i={user:t,roomId:e.channelId};this.videoChatToken&&(i.token=this.videoChatToken,this.videoChatToken=null),socket.emit("joinLeave",JSON.stringify(i))},joinSuccess:function(t){var i=this,n={nick:i.nick,pic:i.pic,userId:i.userId,sessionId:i.sessionId,uid:i.uid,status:"join",userType:i.userType};socket.emit("joinSuccess",JSON.stringify({user:n,roomId:i.channelId}),function(t){i.setPlayerVolume(!1),i.isSendJoinSuccess=!0,i.btnRaise.removeAttr("disabled"),i.callMain.removeClass("no-raise in-raise").addClass("in-call"),e("#call-"+i.userId).find(".connect-mp-talk-status").addClass(i.linkTypeClass).text(i18nText.lmCalling),i.body.addClass("plv-in-calling");try{i.videoChatToken=JSON.parse(t).token}catch(e){console.warn(e)}}),i.sendJoinSuccessCount++,s=setTimeout(function(){i.isSendJoinSuccess||i.sendJoinSuccessCount<3&&i.joinSuccess(),clearTimeout(s),s=null},5e3)},teacherEndCall:function(){var t=this;t.isJoined&&(t.alertBox.html('<p><span class="talk-object">'+i18nText.lmTeacher+"</span> "+i18nText.lmEndedCall+'</p><div class="connect-mp-mask-contain-ft"><button type="button" class="connect-mp-mask-close" id="connect-mp-mask-close">'+i18nText.lmOk+"</button>"+"</div>".trim()),t.alertBoxWrap.show(),t.leaveCall(),e(".connect-mp-mask-close").on("click",function(){t.alertBox.empty(),t.alertBoxWrap.hide()}))},studentEndCall:function(){var t=this;t.alertBox.html("<p>"+i18nText.lmEndCallTip1+' <span class="talk-object">'+i18nText.lmTeacher+"</span> "+i18nText.lmEndCallTip2+"<br/>"+i18nText.lmEndCallTip3+'</p><div class="connect-mp-mask-contain-ft"><button type="button" class="end-talk-ensure">'+i18nText.lmEndCall+'</button><button type="button" class="end-talk-cancel">'+i18nText.lmKeepCall+"</button>"+"</div>".trim()),t.alertBoxWrap.show(),e(".end-talk-ensure").on("click",function(){t.leaveCall(),t.alertBox.empty(),t.alertBoxWrap.hide()}),e(".end-talk-cancel").on("click",function(){t.alertBox.empty(),t.alertBoxWrap.hide()})},errTip:function(t){var i=this;i.alertBox.html("<p>"+t+'</p><div class="connect-mp-mask-contain-ft"><button type="button" class="connect-mp-mask-close" id="connect-mp-mask-close">'+i18nText.lmOk+"</button>"+"</div>".trim()),i.alertBoxWrap.show(),e(".connect-mp-mask-close").on("click",function(){i.alertBox.empty(),i.alertBoxWrap.hide()})},leaveCall:function(){console.log("###leaveCall");var t=this;if(t.initCallStatus(),t.cancelJoinRequest(),t.linkMicrophone.leave().then(function(){}),e("#remote-stream-"+t.teacherId).remove(),"Y"===t.rtcEnabled&&(t.player&&t.player.j2s_resumeVideo&&t.player.j2s_resumeVideo(),e(".player-main").height("100%"),"video"===t.callType)){this.videoCallListDom&&(this.videoCallListDom.remove(),this.videoCallListDom=null);var i=e("#mboxTab"),s=i.children("li").length;i.children("li").eq(0).remove(),i.removeClass("mbox-tab-"+s).addClass("mbox-tab-"+(s-1)).children("li").eq(0).trigger("click"),delete t.videoCallList[t.userId]}},initCallStatus:function(){console.log("###initCallStatus"),this.closeCall=!1,this.isRaise=!1,this.isJoined=!1,this.sendJoinSuccessCount=0,this.isSendJoinSuccess&&this.setPlayerVolume(!0),this.isSendJoinSuccess=!1,e(".self").remove(),this.btnRaise.removeAttr("disabled"),this.callMain.removeClass("in-call in-raise").addClass("no-raise"),this.body.removeClass("plv-in-calling"),clearTimeout(s),s=null},setPlayer:function(e){this.player=e},setTeacherId:function(e){this.teacherId=e}},window.Call=i}(jQuery,LinkMicrophone);