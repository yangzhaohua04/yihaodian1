"use strict";!function(e,n){function t(e){var t=aesjs.utils.utf8.toBytes(s),i=aesjs.utils.utf8.toBytes(r),o=aesjs.utils.hex.toBytes(e),c=new aesjs.ModeOfOperation.cbc(t,i),a=c.decrypt(o),l=aesjs.utils.utf8.fromBytes(a);return JSON.parse(n.decode(l))}function i(n,i){return new Promise(function(o,c){e.ajax({url:i+"/live/v2/channels/"+n+"/mic-auth",type:"get",dataType:"json",data:{type:"web",timestamp:(new Date).getTime()}}).done(function(e){o(t(e.data))})})}function o(n){this.client=null,this.stream=null,this.isJoined=!1,this.isCcb=n.isCcb,this.apiHost=n.apiHost||"https://api.polyv.net",this.videoProfile_360=["e9x6efh6qq","16ad889b3d","e6soizn34h"],e.extend(this,n)}var c=window.AgoraRTC,s="polyvliveSDKAuth",r="1111000011110000";e.getScript("//player.polyv.net/script/js/ajs.js",function(){}),o.prototype={getDevices:function(e){c.getDevices(function(n){"function"==typeof e&&e(n)})},initClient:function(e){var n=this;return new Promise(function(t,i){n.client=c.createClient({mode:"live",codec:"h264"}),n.client.init(e,function(){n.initClienEvent(),t()},function(e){i(e)})})},joinChannel:function(e,n,t){var i=this;return new Promise(function(o,c){i.client.join(e,n,parseInt(t),function(){i.isJoined=!0,o()},function(e){console.log("joinChannel fail:",e),c(e)})})},initStream:function(){var e=this,n={streamID:e.uid,audio:!0,video:e.enableVideo,screen:!1};return e.cameraId?n.cameraId=e.cameraId:e.microphoneId&&(n.microphoneId=e.microphoneId),e.stream=c.createStream(n),e.stream.setVideoProfile(-1!==e.videoProfile_360.indexOf(e.accountId)||!0===e.isCcb?"360p":"180P"),new Promise(function(n,t){e.stream.init(function(){e.stream.enableAudio(),e.success&&e.success.call(e.target,{stream:e.stream}),n()},function(e){t(e)})})},publish:function(){var e=this;e.client.publish(e.stream,function(n){console.log("Publish local stream error: "+n),e.publishErrorCallback&&e.publishErrorCallback()})},join:function(){var e=this;return new Promise(function(n,t){i(e.channel,e.apiHost).then(function(n){return e.appId=n.connect_appId,e.dynamicKey=n.connect_channel_key,e.initClient(e.appId)}).then(function(){return e.joinChannel(e.dynamicKey,e.channel,e.uid)}).then(function(){return e.joinChannelCallBack&&e.joinChannelCallBack(),e.initStream()}).then(function(){e.publish(),n()}).catch(function(e){t(e),console.log(e)})})},leave:function(){var e=this;return e.stream&&e.stream.close(),new Promise(function(n,t){e.client?e.client.leave(function(){e.pubilshSuccess=!1,e.isJoined=!1,n()},function(e){t(e)}):n()})},initClienEvent:function(){var e=this;this.client.on("stream-published",function(n){e.pubilshSuccess=!0}),this.client.on("error",function(n){e.pubilshSuccess=!1,"function"==typeof e.errorFun?e.errorFun.call(e.target,n):console.log(n)}),this.client.on("peer-leave",function(n){"function"==typeof e.peerLeave?e.peerLeave.call(e.target,n):console.log("peer-leave")}),this.client.on("stream-added",function(n){e.client.subscribe(n.stream,function(e){console.log("Subscribe stream failed",e)})}),this.client.on("stream-removed",function(e){console.log("stream-removed")}),this.client.on("stream-subscribed",function(n){"function"==typeof e.streamSubscribed?e.streamSubscribed.call(e.target,n):console.log("stream-subscribed")})}},window.LinkMicrophone=o}(jQuery,Base64);